#!/bin/bash

# Скрипт для обновления бота
BOT_DIR="$HOME/tg_fin_bot"

echo "=== Обновление бота ==="

# Проверка наличия директории
if [ ! -d "$BOT_DIR" ]; then
  echo "Ошибка: Директория $BOT_DIR не существует."
  echo "Сначала установите бота с помощью deploy.sh"
  exit 1
fi

# Переход в директорию проекта
cd "$BOT_DIR"

# Остановка контейнеров
echo "Остановка контейнеров..."
docker-compose down

# Резервное копирование базы данных
echo "Создание резервной копии базы данных..."
if [ -f "expenses.db" ]; then
  cp expenses.db expenses.db.backup
fi

# Обновление из репозитория
echo "Обновление из репозитория..."
if [ -d ".git" ]; then
  git pull
else
  echo "Предупреждение: Директория .git не найдена. Обновление вручную."
  echo "Скопируйте новые файлы в директорию $BOT_DIR"
  read -p "Нажмите Enter для продолжения..."
fi

# Запуск обновленных контейнеров
echo "Запуск обновленных контейнеров..."
docker-compose up -d --build

# Проверка состояния
echo "Проверка состояния контейнеров..."
docker-compose ps

echo "=== Обновление завершено ==="
echo "Бот обновлен и запущен."
echo "Для просмотра логов: docker-compose logs -f" 